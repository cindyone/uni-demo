const t = require('@babel/types')

const {
  INTERNAL_SET_MODEL
} = require('../../../constants')

function getModelEventFunctionExpr (propExpr, propPath) {
  const propPaths = propPath.split('.')
  return t.functionExpression(
    null,
    [t.identifier('$event')],
    t.blockStatement(
      [
        t.returnStatement(
          t.callExpression(
            t.identifier(INTERNAL_SET_MODEL),
            [
              propExpr,
              t.stringLiteral(propPaths.pop()),
              t.identifier('$event')
            ]
          )
        )
      ]
    )
  )
}
module.exports = function processRef (paths, path, state) {
  const modelPath = paths['model']
  if (modelPath) {
    const valueProperty = modelPath.node.value.properties.find(property => {
      return property.key.name === 'value'
    })
    const exprProperty = modelPath.node.value.properties.find(
      property => property.key.name === 'expression'
    )

    const prop = exprProperty.value.value.trim()

    const onPath = paths['on']

    // on:{'input':__m('msg',$event)}
    if (!onPath) {
      path.node.properties.unshift(
        t.objectProperty(t.identifier('on'), t.objectExpression([
          t.objectProperty(
            t.stringLiteral('input'),
            getModelEventFunctionExpr(
              valueProperty.value,
              prop
            )
          )
        ]))
      )
      paths['on'] = path.get('properties').find(
        propertyPath => propertyPath.node.key.name === 'on'
      )
    } else {
      const existingInput = onPath.node.value.properties.find(
        property => property.key.value === 'input'
      )
      if (existingInput) {
        if (!t.isArrayExpression(existingInput.value)) {
          existingInput.value = t.arrayExpression([existingInput.value])
        }
        existingInput.value.elements.unshift(getModelEventFunctionExpr(
          valueProperty.value,
          prop
        ))
      } else {
        onPath.node.value.properties.push(
          t.objectProperty(
            t.stringLiteral('input'),
            getModelEventFunctionExpr(
              valueProperty.value,
              prop
            )
          )
        )
      }
    }

    return [ // attrs:{value:value}
      t.objectProperty(
        t.stringLiteral('value'),
        t.identifier(prop)
      )
    ]
  }
  return []
}
